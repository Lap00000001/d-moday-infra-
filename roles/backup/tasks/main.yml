---
# roles/backup/tasks/main.yml
- name: Ensure restic package is present (Debian/Ubuntu)
  apt:
    name: restic
    state: present
    update_cache: yes
  when: ansible_os_family == 'Debian'

- name: Ensure restic directory for logs exists
  file:
    path: /var/log/restic
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Deploy restic env file
  template:
    src: restic_env.j2
    dest: /etc/restic_env
    owner: root
    group: root
    mode: '0600'
  no_log: true

- name: Initialize restic repo if empty (run snapshots to check)
  shell: |
    set -o pipefail
    source /etc/restic_env
    restic snapshots >/dev/null 2>&1 || restic init
  args:
    executable: /bin/bash
  register: restic_init
  changed_when: restic_init.rc == 0 and "'created new repo' in (restic_init.stdout|default(''))"
  # it's noisy; no_log to hide secrets
  no_log: true
  ignore_errors: yes

- name: Install cron job for restic backup
  cron:
    name: "restic-daily-backup"
    minute: "{{ backup_cron_minute | default('30') }}"
    hour: "{{ backup_cron_hour | default('2') }}"
    user: "{{ backup_cron_user | default('root') }}"
    job: "source /etc/restic_env && /usr/bin/restic backup {{ backup_paths | join(' ') }} --tag {{ inventory_hostname }} >> /var/log/restic/{{ inventory_hostname }}.log 2>&1"
